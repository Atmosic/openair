common:
  tags:
    - drivers
    - fault_storage
    - requires_trustzone
  sysbuild: true
  timeout: 30

tests:
  tests.drivers.atm_spe_sec_fault_storage.atm:
    harness: console
    harness_config:
      type: multi_line
      regex:
        - "=== SPE SECURE FAULT DETECTED ==="
        - "SPE SECURE FAULT"
        - "Fault Reason: [0-9]+"
      ordered: true
    extra_args:
      - SB_CONFIG_SPE=y
      - SB_ATM_DTS_EXTRA_CPPFLAGS="-DATM_SEC_FAULT_STORAGE"
    extra_configs:
      - CONFIG_LOG_MODE_IMMEDIATE=y
      - CONFIG_ATM_SPE_FAULT_STORAGE=y
  tests.drivers.atm_spe_sec_fault_storage.atm.mcuboot:
    harness: console
    harness_config:
      type: multi_line
      regex:
        - "=== SPE SECURE FAULT DETECTED ==="
        - "SPE SECURE FAULT"
        - "Fault Reason: [0-9]+"
      ordered: true
    extra_args:
      - SB_CONFIG_SPE=y
      - SB_ATM_DTS_EXTRA_CPPFLAGS="-DATM_SEC_FAULT_STORAGE"
      - SB_CONFIG_BOOTLOADER_MCUBOOT=y
      - SB_CONFIG_BOOT_SIGNATURE_TYPE_ECDSA_P256=y
      - SB_CONFIG_MCUBOOT_MODE_SWAP_SCRATCH=y
    extra_configs:
      - CONFIG_LOG_MODE_IMMEDIATE=y
      - CONFIG_ATM_SPE_FAULT_STORAGE=y
  tests.drivers.atm_spe_sec_fault_storage.atm.log_panic:
    harness: console
    harness_config:
      type: one_line
      regex:
        - "TEST LOG PANIC SAVE COMPLETE"
    extra_args:
      - SB_CONFIG_SPE=y
      - SB_ATM_DTS_EXTRA_CPPFLAGS="-DATM_SEC_FAULT_STORAGE"
    extra_configs:
      - CONFIG_LOG=y
      - CONFIG_TEST_LOGGING_DEFAULTS=n
      - CONFIG_TEST_LOG_PANIC=y
      - CONFIG_ATM_SPE_FAULT_STORAGE=y
  tests.drivers.atm_spe_sec_fault_storage.atm.mcuboot.log_panic:
    harness: console
    harness_config:
      type: one_line
      regex:
        - "TEST LOG PANIC SAVE COMPLETE"
    extra_args:
      - SB_CONFIG_SPE=y
      - SB_ATM_DTS_EXTRA_CPPFLAGS="-DATM_SEC_FAULT_STORAGE"
      - SB_CONFIG_BOOTLOADER_MCUBOOT=y
      - SB_CONFIG_BOOT_SIGNATURE_TYPE_ECDSA_P256=y
      - SB_CONFIG_MCUBOOT_MODE_SWAP_SCRATCH=y
    extra_configs:
      - CONFIG_LOG=y
      - CONFIG_TEST_LOGGING_DEFAULTS=n
      - CONFIG_TEST_LOG_PANIC=y
      - CONFIG_ATM_SPE_FAULT_STORAGE=y
